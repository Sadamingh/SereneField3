<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Data Pipeline 2 | Airflow Architecture and Directed Acyclic Graph</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Data Pipeline 2 | Airflow Architecture and Directed Acyclic Graph</h1>
</header>
<section data-field="subtitle" class="p-summary">
Series: Data Pipeline
</section>
<section data-field="body" class="e-content">
<section name="3ef7" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="c386" id="c386" class="graf graf--h3 graf--leading graf--title">Data Pipeline 2 | <strong class="markup--strong markup--h3-strong">Airflow Architecture and Directed Acyclic Graph</strong></h3><figure name="9076" id="9076" class="graf graf--figure graf-after--h3"><img class="graf-image" data-image-id="0*tkZBuH6pJclyRNxi.png" data-width="1352" data-height="622" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/0*tkZBuH6pJclyRNxi.png"></figure><ol class="postList"><li name="166d" id="166d" class="graf graf--li graf-after--figure"><strong class="markup--strong markup--li-strong">Airflow Architecture</strong></li></ol><p name="f012" id="f012" class="graf graf--p graf-after--li"><strong class="markup--strong markup--p-strong">(1) The Components of Airflow</strong></p><ul class="postList"><li name="3173" id="3173" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong">Scheduler</strong>: handling the triggered workflows and submitting tasks to executors</li><li name="a39f" id="a39f" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Executor</strong>: handling the running tasks. A local Airflow will build this executor inside the scheduler but for production, the scheduler will push tasks out to executable workers. There are two types of executors, local executors (e.g. debug executor, local executor, sequential executor) or remote executors (e.g. Celery executor, Kubernetes executor, Dask executor).</li></ul><p name="d8b8" id="d8b8" class="graf graf--p graf-after--li">b. Remote Executors Celery Executor CeleryKubernetes Executor Dask Executor Kubernetes Executor</p><ul class="postList"><li name="3583" id="3583" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong">Webserver</strong>: Airflow provides a web UI we have seen previously to inspect, trigger and debug the behavior of DAGs and tasks</li><li name="b9cd" id="b9cd" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">DAG Directory</strong>: Airflow provides a DAG directory <code class="markup--code markup--li-code">dags_folder</code> where we can store our DAGs. We can also change this directory as we have discussed.</li><li name="fb19" id="fb19" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Metadata Database</strong>: This is a database used by the scheduler, executor, and webserver to store the DAG states.</li></ul><figure name="81c3" id="81c3" class="graf graf--figure graf-after--li"><img class="graf-image" data-image-id="1*oR5hkL9UpgrDm-dn2XqH0A.png" data-width="1126" data-height="593" src="https://cdn-images-1.medium.com/max/800/1*oR5hkL9UpgrDm-dn2XqH0A.png"><figcaption class="imageCaption">Data Pipelines with Apache Airflow, Bas Harenslak and Julian de Ruiter, page 12</figcaption></figure><p name="5aea" id="5aea" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">(2) Three Types of Tasks</strong></p><p name="2889" id="2889" class="graf graf--p graf-after--p">In the previous Hello World example, we have used the <code class="markup--code markup--p-code">BashOperator</code> , which can be used to execute bash commands. Now, it’s time for us to view more types of tasks.</p><p name="6dc9" id="6dc9" class="graf graf--p graf-after--p">a.<strong class="markup--strong markup--p-strong"> Operators</strong>: these are predefined tasks that can be strung together quickly. Note that all the operators are inherited from the class <code class="markup--code markup--p-code">BaseOperator</code>.</p><ul class="postList"><li name="cc7d" id="cc7d" class="graf graf--li graf-after--p"><code class="markup--code markup--li-code">BashOperator</code>: used to create bash tasks</li><li name="cd41" id="cd41" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">PythonOperator</code>: used to create Python callback functions tasks</li><li name="f1db" id="f1db" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">BigQueryOperator</code>: used to create BigQuery SQL query tasks</li><li name="d52b" id="d52b" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">EmailOperator</code>: used to create email-sending tasks</li><li name="118c" id="118c" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">DummyOperator</code>: an operator that does nothing, and it is commonly used to group tasks</li></ul><p name="d879" id="d879" class="graf graf--p graf-after--li">b. <strong class="markup--strong markup--p-strong">Sensors</strong>: Sensors are a special type of operator that are designed to wait for a specific event. All they do is wait until something happens, and then succeed so their downstream tasks can run.</p><ul class="postList"><li name="050d" id="050d" class="graf graf--li graf-after--p"><code class="markup--code markup--li-code">HdfsSensor</code> : used to wait for a file or a folder in HDFS</li></ul><p name="6f4c" id="6f4c" class="graf graf--p graf-after--li">c. <strong class="markup--strong markup--p-strong">TaskFlow</strong>: this is a new feature in Airflow 2.0 and this allows us to decorate Python functions with <code class="markup--code markup--p-code">@task</code> without extra boilerplates. We will talk about it later.</p><p name="0df1" id="0df1" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">(3) Tasks Control Flow</strong></p><p name="d705" id="d705" class="graf graf--p graf-after--p">In Airflow, DAGs are designed to reuse and they can also run in parallel. In order to achieve this feature, the dependencies of tasks should be explicitly declared by <code class="markup--code markup--p-code">&gt;&gt;</code> or <code class="markup--code markup--p-code">&lt;&lt;</code> operators. For example, if <code class="markup--code markup--p-code">task_2</code> is depended on <code class="markup--code markup--p-code">task_1</code> , we will have,</p><pre name="2ab6" id="2ab6" class="graf graf--pre graf-after--p">task_1 &gt;&gt; task_2</pre><p name="e59f" id="e59f" class="graf graf--p graf-after--pre">or,</p><pre name="aef6" id="aef6" class="graf graf--pre graf-after--p">task_2 &lt;&lt; task_1</pre><p name="3e8b" id="3e8b" class="graf graf--p graf-after--pre">We can also declare this dependency by <code class="markup--code markup--p-code">set_downstream</code> or <code class="markup--code markup--p-code">set_upstream</code> methods. For example, if <code class="markup--code markup--p-code">task_2</code> is depended on <code class="markup--code markup--p-code">task_1</code> , we will have,</p><pre name="302c" id="302c" class="graf graf--pre graf-after--p">task_1.set_downstream(task_2)</pre><p name="0770" id="0770" class="graf graf--p graf-after--pre">or,</p><pre name="43e0" id="43e0" class="graf graf--pre graf-after--p">task_2.set_upstream(task_1)</pre><p name="3bb2" id="3bb2" class="graf graf--p graf-after--pre">These dependencies are what make up the “edges” of the DAGs that we will explain in a minute.</p><p name="9c98" id="9c98" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">(4) Task Instance States</strong></p><p name="9efb" id="9efb" class="graf graf--p graf-after--p">For each time a DAG runs, the tasks under this DAG are instantiated into task instances. A task instance can have several states representing what stage of the lifecycle it is in. The possible states for a task instance are,</p><ul class="postList"><li name="16e4" id="16e4" class="graf graf--li graf-after--p"><code class="markup--code markup--li-code">none</code>: the task hasn’t been scheduled yet</li><li name="0552" id="0552" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">scheduled</code>: the task has its dependencies met and should be able to run</li><li name="dfe0" id="dfe0" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">queued</code>: the task has been allocated to an executor but it is waiting for the next available worker</li><li name="122e" id="122e" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">running</code>: the task is currently running on an executor</li><li name="7cae" id="7cae" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">success</code>: the task finished running without errors</li><li name="5a1b" id="5a1b" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">failed</code>: the task had an error during the execution</li><li name="730b" id="730b" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">up_for_retry</code>: the task failed, but has retry attempts left and will be rescheduled.</li><li name="dbf8" id="dbf8" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">skipped</code>: the task was skipped due to branching</li></ul><figure name="828c" id="828c" class="graf graf--figure graf-after--li"><img class="graf-image" data-image-id="1*SM81ldPgu1K-BAcSvtjEbg.png" data-width="1113" data-height="663" src="https://cdn-images-1.medium.com/max/800/1*SM81ldPgu1K-BAcSvtjEbg.png"><figcaption class="imageCaption">Source: <a href="https://airflow.apache.org/docs/apache-airflow/stable/concepts/tasks.html" data-href="https://airflow.apache.org/docs/apache-airflow/stable/concepts/tasks.html" class="markup--anchor markup--figure-anchor" rel="nofollow noopener" target="_blank">https://airflow.apache.org/docs/apache-airflow/stable/concepts/tasks.html</a></figcaption></figure><p name="453b" id="453b" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">2. Directed Acyclic Graph (DAG)</strong></p><p name="7ee0" id="7ee0" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">(1) The Definition of Directed Acyclic Graph</strong></p><p name="2489" id="2489" class="graf graf--p graf-after--p">An acyclic graph is a graph having no graph cycles, and a directed graph is a set of nodes that are connected together, where all the edges are directed from one vertex to another. So a DAG is a graph that contains directed edges and does not contain any loops.</p><p name="1a3c" id="1a3c" class="graf graf--p graf-after--p">It is tricky that a DAG can have non-looping cycles. So the key point is that you should not only care about the shape formed by edges, but also the directions of the edges. For example,</p><figure name="d364" id="d364" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*Jg5kCi5t67p68U69ejqtDA.png" data-width="669" data-height="121" src="https://cdn-images-1.medium.com/max/800/1*Jg5kCi5t67p68U69ejqtDA.png"></figure><p name="f32b" id="f32b" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">(2) Features of DAG</strong></p><p name="1263" id="1263" class="graf graf--p graf-after--p">A DAG is a container that is used to organize tasks and set their execution context. DAGs do not perform any actual computation. Instead, Operators determine what actually gets done. The DAG itself doesn’t care about what is happening inside the tasks; it is merely concerned with how to execute them — the order to run them in, how many times to retry them, if they have timeouts, and so on.</p><p name="1163" id="1163" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">(3) DAG Creation</strong></p><p name="b61a" id="b61a" class="graf graf--p graf-after--p">Commonly, there are three ways to create a DAG. First, we can use a context manager of <code class="markup--code markup--p-code">with ... as ...</code> structure,</p><pre name="17d0" id="17d0" class="graf graf--pre graf-after--p">with DAG(&quot;my_dag_name&quot;) as dag:<br>    dummy = DummyOperator(task_id=&quot;test_task&quot;)</pre><p name="b8dc" id="b8dc" class="graf graf--p graf-after--pre">Or we can use a standard constructor like,</p><pre name="3113" id="3113" class="graf graf--pre graf-after--p">my_dag = DAG(&quot;my_dag_name&quot;)<br>op = DummyOperator(task_id=&quot;task&quot;, dag=my_dag)</pre><p name="bfca" id="bfca" class="graf graf--p graf-after--pre graf--trailing">We can also use the <code class="markup--code markup--p-code">@dag</code> decorator, but we will not display it here.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@adamedelweiss" class="p-author h-card">Adam Edelweiss</a> on <a href="https://medium.com/p/c4cd9949af0e"><time class="dt-published" datetime="2021-12-01T08:49:29.726Z">December 1, 2021</time></a>.</p><p><a href="https://medium.com/@adamedelweiss/data-pipeline-2-airflow-architecture-and-directed-acyclic-graph-c4cd9949af0e" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on December 15, 2021.</p></footer></article></body></html>