<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Distributed Computing 4 | AWS IAM Configurations, Amazon EMR and Spark Clusters</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Distributed Computing 4 | AWS IAM Configurations, Amazon EMR and Spark Clusters</h1>
</header>
<section data-field="subtitle" class="p-summary">
Series: Distributed Computing
</section>
<section data-field="body" class="e-content">
<section name="5dce" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="6488" id="6488" class="graf graf--h3 graf--leading graf--title">Distributed Computing 4 | <strong class="markup--strong markup--h3-strong">AWS IAM Configurations, Amazon EMR, and Spark Clusters</strong></h3><figure name="419a" id="419a" class="graf graf--figure graf-after--h3"><img class="graf-image" data-image-id="0*vftLasDyONKBbjY7.png" data-width="1144" data-height="634" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/0*vftLasDyONKBbjY7.png"></figure><blockquote name="4a21" id="4a21" class="graf graf--blockquote graf-after--figure"><strong class="markup--strong markup--blockquote-strong">Note</strong>: If you meet any problems when following the instructions, my recommendation is to delete the things you have done and do all the things again.</blockquote><ol class="postList"><li name="d73e" id="d73e" class="graf graf--li graf-after--blockquote"><strong class="markup--strong markup--li-strong">AWS IAM Configurations</strong></li></ol><p name="db1e" id="db1e" class="graf graf--p graf-after--li"><strong class="markup--strong markup--p-strong">(1) The Overview of AWS Pipeline</strong></p><ul class="postList"><li name="b29d" id="b29d" class="graf graf--li graf-after--p">Upload the data to AWS S3</li><li name="4bb9" id="4bb9" class="graf graf--li graf-after--li">Manage collaboration by AWS IAM</li><li name="dd36" id="dd36" class="graf graf--li graf-after--li">Transfer to AWS EMR</li><li name="d140" id="d140" class="graf graf--li graf-after--li">Transfer to third party software like Plotly</li></ul><p name="bce2" id="bce2" class="graf graf--p graf-after--li"><strong class="markup--strong markup--p-strong">(2) The Definition of IAM</strong></p><p name="9bc1" id="9bc1" class="graf graf--p graf-after--p">The identity and access management (IAM) system of AWS enables to manage access to AWS services by allowing to manage the AWS user groups.</p><p name="7c33" id="7c33" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">(3) Creating IAM</strong></p><p name="cdcc" id="cdcc" class="graf graf--p graf-after--p">The procedure of creating IAMs should be as follows,</p><ul class="postList"><li name="bc34" id="bc34" class="graf graf--li graf-after--p">Go to <a href="https://aws.amazon.com/" data-href="https://aws.amazon.com/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">AWS.com</a></li><li name="2c5e" id="2c5e" class="graf graf--li graf-after--li">Sign in to the console</li><li name="1645" id="1645" class="graf graf--li graf-after--li">Select Root User</li><li name="6d07" id="6d07" class="graf graf--li graf-after--li">Enter the email address</li><li name="524f" id="524f" class="graf graf--li graf-after--li">Enter the password</li><li name="c523" id="c523" class="graf graf--li graf-after--li">Search for IAM and redirect to the IAM dashboard</li><li name="6e6e" id="6e6e" class="graf graf--li graf-after--li">Select <code class="markup--code markup--li-code">Access management &gt; Users</code> in the left navigation bar (this should be the default page)</li><li name="996a" id="996a" class="graf graf--li graf-after--li">Select <code class="markup--code markup--li-code">Add users</code></li><li name="f1e4" id="f1e4" class="graf graf--li graf-after--li">Enter the <code class="markup--code markup--li-code">User name</code> you want to add to your project (e.g. <code class="markup--code markup--li-code">Adam</code>)</li><li name="c6c7" id="c6c7" class="graf graf--li graf-after--li">Check both the <code class="markup--code markup--li-code">Access key</code> (means the IAM user can use AWS CLI) and <code class="markup--code markup--li-code">Password</code> (means the IAM user can access AWS console/website)</li><li name="f404" id="f404" class="graf graf--li graf-after--li">We can choose to autogenerate a password for this user or enter a custom password. Here we would like to make everything simple and we just choose the default settings of autogenerating the password and requiring the IAM user to reset it after the first time they log in.</li><li name="824e" id="824e" class="graf graf--li graf-after--li">Select <code class="markup--code markup--li-code">Next: Permissions</code> to continue.</li><li name="4519" id="4519" class="graf graf--li graf-after--li">Select <code class="markup--code markup--li-code">Create group</code> to create a new IAM user group. From this group management, we can manage the accessibility to the resources of this IAM user.</li><li name="a8c0" id="a8c0" class="graf graf--li graf-after--li">Next, we should enter a <code class="markup--code markup--li-code">Group name</code> (e.g. <code class="markup--code markup--li-code">TestingGroup</code>) that will be used to authorize a series of resource accessibility.</li></ul><figure name="7ab9" id="7ab9" class="graf graf--figure graf-after--li"><img class="graf-image" data-image-id="1*P2wifY1mC6DEmAniWeB_kw.png" data-width="728" data-height="216" src="https://cdn-images-1.medium.com/max/800/1*P2wifY1mC6DEmAniWeB_kw.png"></figure><ul class="postList"><li name="691a" id="691a" class="graf graf--li graf-after--figure">First, let’s authorize the accessibility to S3. Let’s first search <code class="markup--code markup--li-code">S3</code> among the policies. If we would like to be open to all the operations, we can check <code class="markup--code markup--li-code">AmazonS3FullAccess</code> (means the IAM users can r/w). We are going to check this for simplicity.</li><li name="a09d" id="a09d" class="graf graf--li graf-after--li">Second, we also want to authorize the accessibility to EMR. Let’s then search for <code class="markup--code markup--li-code">elasticmap</code>, and from the result, we can check <code class="markup--code markup--li-code">AmazonElasticMapReduceFullAccess</code> for again, simplicity.</li><li name="a85e" id="a85e" class="graf graf--li graf-after--li">Click on <code class="markup--code markup--li-code">Create group</code> to continue.</li><li name="1a81" id="1a81" class="graf graf--li graf-after--li">Select the group (e.g. <code class="markup--code markup--li-code">TestingGroup</code>) we have created.</li><li name="b48e" id="b48e" class="graf graf--li graf-after--li">Click on <code class="markup--code markup--li-code">Next: Tags</code> to continue.</li><li name="9868" id="9868" class="graf graf--li graf-after--li">The tag section is optional but it does provide some IAM user-specific management. We can add no more than 50 tags to a specific user and then use these tags to organize, track, or control access for this IAM user. We are going to skip this part for simplicity.</li><li name="24e9" id="24e9" class="graf graf--li graf-after--li">Click on <code class="markup--code markup--li-code">Next: Review</code> to continue.</li><li name="46a4" id="46a4" class="graf graf--li graf-after--li">From the review page, we can check again if all the settings for this user are correct because we may have serious problems if we assigned the wrong permissions. So make sure all the settings are correct before you click on <code class="markup--code markup--li-code">Create user</code>.</li><li name="9863" id="9863" class="graf graf--li graf-after--li">Now, we have already created the user and we can download user security credentials by a CSV file. Also, we can also send an email as we wish. If we don’t necessarily need to download the CSV file because we can retrieve all the IAM user information back. Let’s see how it works.</li><li name="6d46" id="6d46" class="graf graf--li graf-after--li">Go back to the IAM dashboard, select <code class="markup--code markup--li-code">Access management &gt; Users</code>.</li><li name="12b4" id="12b4" class="graf graf--li graf-after--li">Click on the name of the new user (e.g. <code class="markup--code markup--li-code">Adam</code>) we have created just now.</li><li name="d1e6" id="d1e6" class="graf graf--li graf-after--li">Select <code class="markup--code markup--li-code">Security Credentials</code>.</li></ul><figure name="9210" id="9210" class="graf graf--figure graf-after--li"><img class="graf-image" data-image-id="1*SB04XeEO79C_ABb-5Uc55Q.png" data-width="1822" data-height="290" src="https://cdn-images-1.medium.com/max/800/1*SB04XeEO79C_ABb-5Uc55Q.png"></figure><ul class="postList"><li name="7b78" id="7b78" class="graf graf--li graf-after--figure">From this section, we can get the Console sign-in link, which can be used to sign in as an IAM user. Also, we can reset the password we generated because we may not save the previous CSV file. Click on <code class="markup--code markup--li-code">Manage</code> after the <code class="markup--code markup--li-code">Console password</code> . Then check <code class="markup--code markup--li-code">Set password &gt; Autogenerated password</code>. Check the box of <code class="markup--code markup--li-code">Require password reset</code>. Then click on <code class="markup--code markup--li-code">Apply</code>.</li><li name="99b3" id="99b3" class="graf graf--li graf-after--li">Then click on <code class="markup--code markup--li-code">Show</code> after <code class="markup--code markup--li-code">Console password</code> . Note that this should be stored somewhere and after you close this window, if the password is lost, you must create a new one. For example, my autogenerated password is,</li></ul><pre name="4a5c" id="4a5c" class="graf graf--pre graf-after--li">)%|vYR-vji5cN!s</pre><ul class="postList"><li name="f4e6" id="f4e6" class="graf graf--li graf-after--pre">Then we go to the <code class="markup--code markup--li-code">Console sign-in link</code> shown in your Sign-in credentials,</li></ul><pre name="97e3" id="97e3" class="graf graf--pre graf-after--li">Goto: https://&lt;Numbers&gt;.signin.aws.amazon.com/console</pre><p name="d5b6" id="d5b6" class="graf graf--p graf-after--pre">Your current account will be logged out if you enter this sign-in page in your browser.</p><ul class="postList"><li name="f81e" id="f81e" class="graf graf--li graf-after--p">Keep the <code class="markup--code markup--li-code">Account ID</code> , then enter the IAM user login information,</li></ul><pre name="c92e" id="c92e" class="graf graf--pre graf-after--li">IAM user name: Adam<br>Password: )%|vYR-vji5cN!s</pre><ul class="postList"><li name="20ee" id="20ee" class="graf graf--li graf-after--pre">Click on Sign in to log into this IAM account.</li><li name="2490" id="2490" class="graf graf--li graf-after--li">Then, because we, as the root user, checked the box for <code class="markup--code markup--li-code">Require password reset</code> when conducting the configurations. We have to reset the password. So, enter a new password and confirm it.</li><li name="eed8" id="eed8" class="graf graf--li graf-after--li">Now, check if we can access EMR and S3.</li><li name="d507" id="d507" class="graf graf--li graf-after--li">Now, check if we can create a new RDS database. You must not be able to do that because this IAM user is not authorized to perform RDS operations.</li></ul><p name="240e" id="240e" class="graf graf--p graf-after--li"><strong class="markup--strong markup--p-strong">(4) Add IAM User to AWS CLI</strong></p><p name="0975" id="0975" class="graf graf--p graf-after--p">If you haven’t installed AWS CLI before, it’s time to install it. You may use the following command to install the AWS command line to,</p><pre name="cae0" id="cae0" class="graf graf--pre graf-after--p">$ curl &quot;<a href="https://awscli.amazonaws.com/AWSCLIV2.pkg" data-href="https://awscli.amazonaws.com/AWSCLIV2.pkg" class="markup--anchor markup--pre-anchor" rel="nofollow noopener" target="_blank">https://awscli.amazonaws.com/AWSCLIV2.pkg</a>&quot; -o &quot;AWSCLIV2.pkg&quot;<br>$ sudo installer -pkg AWSCLIV2.pkg -target /</pre><p name="fb71" id="fb71" class="graf graf--p graf-after--pre">Then check if we installed it successfully,</p><pre name="767f" id="767f" class="graf graf--pre graf-after--p">$ aws --version</pre><p name="8233" id="8233" class="graf graf--p graf-after--pre">Then, let’s add the IAM user to our account.</p><ul class="postList"><li name="1b04" id="1b04" class="graf graf--li graf-after--p">First, go back to the root user’s IAM dashboard</li><li name="8508" id="8508" class="graf graf--li graf-after--li">Find the IAM user we have created (e.g. <code class="markup--code markup--li-code">Adam</code>), select <code class="markup--code markup--li-code">Security credentials</code></li><li name="ea93" id="ea93" class="graf graf--li graf-after--li">From the Access keys section, click on <code class="markup--code markup--li-code">Create access key</code> . Click on <code class="markup--code markup--li-code">Show</code> to reveal the <code class="markup--code markup--li-code">Secret access key</code> , record these two keys (i.e. <code class="markup--code markup--li-code">Access key ID</code> and <code class="markup--code markup--li-code">Secret access key</code>) somewhere</li><li name="885c" id="885c" class="graf graf--li graf-after--li">Second, type in the following command,</li></ul><pre name="b699" id="b699" class="graf graf--pre graf-after--li">$ aws configure</pre><ul class="postList"><li name="544a" id="544a" class="graf graf--li graf-after--pre">Then enter the <code class="markup--code markup--li-code">Access key ID</code> and <code class="markup--code markup--li-code">Secret access key</code></li></ul><pre name="d30a" id="d30a" class="graf graf--pre graf-after--li">AWS Access Key ID [****************K3MZ]: ...<br>AWS Secret Access Key [****************o8yJ]: ...<br>Default region name [us-east-1]:<br>Default output format [None]:</pre><p name="45eb" id="45eb" class="graf graf--p graf-after--pre"><strong class="markup--strong markup--p-strong">(5) Log in as Root User by SSH</strong></p><p name="e21b" id="e21b" class="graf graf--p graf-after--p">Now that we have discussed the AWS CLI, let’s discuss the SSH accessibility. For SSH login, we have to generate a PEM file. This approach of SSH login is extremely useful when we have to get the console of an EC2 service. Now, let’s see how it works.</p><ul class="postList"><li name="d715" id="d715" class="graf graf--li graf-after--p">Log in as the root user</li><li name="43b6" id="43b6" class="graf graf--li graf-after--li">Let’s first search for EC2.</li><li name="3178" id="3178" class="graf graf--li graf-after--li">Select <code class="markup--code markup--li-code">Network &amp; Security &gt; Key Pairs</code> in the left navigation bar.</li><li name="d0b2" id="d0b2" class="graf graf--li graf-after--li">Click on <code class="markup--code markup--li-code">Create key pair</code></li><li name="03eb" id="03eb" class="graf graf--li graf-after--li">Enter a name (e.g. <code class="markup--code markup--li-code">Adam</code>) and keep the other settings.</li><li name="5586" id="5586" class="graf graf--li graf-after--li">Click on <code class="markup--code markup--li-code">Create key pair</code> to download a PEM file</li><li name="6d3b" id="6d3b" class="graf graf--li graf-after--li">Finally, let’s store it somewhere so that we can use it for logging into the EC2 service in the future.</li></ul><p name="10c1" id="10c1" class="graf graf--p graf-after--li"><strong class="markup--strong markup--p-strong">(6) Authorizing an S3 Bucket to an IAM User</strong></p><ul class="postList"><li name="5209" id="5209" class="graf graf--li graf-after--p">Go to the IAM dashboard, select <code class="markup--code markup--li-code">Users</code></li><li name="9ca9" id="9ca9" class="graf graf--li graf-after--li">Click on the username (e.g. <code class="markup--code markup--li-code">Adam</code>) we have created</li><li name="a7a5" id="a7a5" class="graf graf--li graf-after--li">Copy the <code class="markup--code markup--li-code">Summary &gt; User ARN</code> information</li><li name="cabf" id="cabf" class="graf graf--li graf-after--li">Then, redirect to the S3 dashboard</li><li name="be9f" id="be9f" class="graf graf--li graf-after--li">Click on the non-public bucket name we would like to add this IAM user</li><li name="4792" id="4792" class="graf graf--li graf-after--li">Select <code class="markup--code markup--li-code">Permissions</code></li><li name="6885" id="6885" class="graf graf--li graf-after--li">Find <code class="markup--code markup--li-code">Bucket policy</code> and then click on <code class="markup--code markup--li-code">Edit</code></li><li name="995f" id="995f" class="graf graf--li graf-after--li">Click on <code class="markup--code markup--li-code">Policy generator</code></li><li name="dee9" id="dee9" class="graf graf--li graf-after--li">Select <code class="markup--code markup--li-code">S3 Bucket Policy</code></li><li name="3108" id="3108" class="graf graf--li graf-after--li">Add the IAM user’s <code class="markup--code markup--li-code">User ARN</code> as the <code class="markup--code markup--li-code">Principle</code></li><li name="14b9" id="14b9" class="graf graf--li graf-after--li">Select <code class="markup--code markup--li-code">GetObject</code> in the actions to allow read-only behavior</li><li name="4bf2" id="4bf2" class="graf graf--li graf-after--li">The <code class="markup--code markup--li-code">Amazon Resource Name (ARN)</code> should have the following pattern,</li></ul><pre name="3195" id="3195" class="graf graf--pre graf-after--li">arn:aws:s3:::${BucketName}/${KeyName}</pre><p name="4098" id="4098" class="graf graf--p graf-after--pre">where the <code class="markup--code markup--p-code">${BucketName}</code> should be the bucket name we want to authorize, and <code class="markup--code markup--p-code">${KeyName}</code> should be the files we want to allow access. If we want to allow accessing all the files, we can put a <code class="markup--code markup--p-code">*</code> sign here.</p><ul class="postList"><li name="1cb6" id="1cb6" class="graf graf--li graf-after--p">Click on <code class="markup--code markup--li-code">Add Statement</code> to add this record</li><li name="4d90" id="4d90" class="graf graf--li graf-after--li">Then click <code class="markup--code markup--li-code">Generate Policy</code> to generate this policy</li><li name="7075" id="7075" class="graf graf--li graf-after--li">Copy the JSON document generated</li><li name="c880" id="c880" class="graf graf--li graf-after--li">Paste in the <code class="markup--code markup--li-code">Bucket polity</code></li><li name="c239" id="c239" class="graf graf--li graf-after--li">Click on <code class="markup--code markup--li-code">Save changes</code> to save this permission</li></ul><p name="debe" id="debe" class="graf graf--p graf-after--li"><strong class="markup--strong markup--p-strong">2. Amazon EMR and Spark Clusters</strong></p><p name="51cb" id="51cb" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">(1) Spark Cluster</strong></p><p name="2221" id="2221" class="graf graf--p graf-after--p">Now we are basically running the program in the local mode and we have to run it in a cluster mode if we want to achieve higher performance for a larger scale of data. As we have mentioned before, the Spark cluster is a set of interconnected processes running in a distributed manner on different machines. Basically, there are three types of Spark cluster managers,</p><ul class="postList"><li name="2109" id="2109" class="graf graf--li graf-after--p">Spark standalone</li><li name="562e" id="562e" class="graf graf--li graf-after--li">Hadoop YARN</li><li name="9659" id="9659" class="graf graf--li graf-after--li">Apache Mesos</li></ul><p name="3c03" id="3c03" class="graf graf--p graf-after--li"><strong class="markup--strong markup--p-strong">(2) Components of the Spark Runtime System</strong></p><p name="0180" id="0180" class="graf graf--p graf-after--p">In the Spark architecture, we have three major components,</p><ul class="postList"><li name="5227" id="5227" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong">Client</strong>: client is the physical or virtual machine we start the driver program by spark-submit, pyspark, spark-shell scripts, etc.</li><li name="b223" id="b223" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Driver</strong>: driver is the physical or virtual machine that orchestrates and monitors all the executors of a Spark application. The driver is in charge of checking the resources, distributing the jobs/tasks to executors, receiving the computed outputs from the executors, and sending them back to the client. Note we have only one diver per Spark application.</li><li name="3c38" id="3c38" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Executor</strong>: executors are the execution units that execute Spark tasks with a configuration with a configurable number of cores. Each executor stores and caches the data partitions only in its memory.</li></ul><p name="f171" id="f171" class="graf graf--p graf-after--li"><strong class="markup--strong markup--p-strong">(3) The Definition of Elastic MapReduce (EMR)</strong></p><p name="fc71" id="fc71" class="graf graf--p graf-after--p">EMR (aka. Elastic MapReduce) is a connected structure of the EC2 instances so that we can leverage a dynamically scalable EC2 network through this service. Because we are going to use AWS EMR as our Spark clusters, we are going to use Hadoop’s <strong class="markup--strong markup--p-strong">YARN</strong> (aka. Yet Another Resource Negotiator). It can handle the HDFS mode while Spark standalone can not.</p><p name="56a9" id="56a9" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">(4) Creating an EMR Cluster</strong></p><ul class="postList"><li name="1749" id="1749" class="graf graf--li graf-after--p">First, let’s log in as the IAM user</li><li name="93c6" id="93c6" class="graf graf--li graf-after--li">From the left navigation bar, select <code class="markup--code markup--li-code">Clusters</code></li><li name="fe04" id="fe04" class="graf graf--li graf-after--li">Click on <code class="markup--code markup--li-code">Create cluster</code></li><li name="78a1" id="78a1" class="graf graf--li graf-after--li">Select <code class="markup--code markup--li-code">Go to advanced options</code></li><li name="ddd9" id="ddd9" class="graf graf--li graf-after--li">Select <code class="markup--code markup--li-code">Release</code> version as <code class="markup--code markup--li-code">emr-6.3.0</code></li><li name="aa86" id="aa86" class="graf graf--li graf-after--li">Check <code class="markup--code markup--li-code">Hadoop 3.2.1</code> and <code class="markup--code markup--li-code">Spark 3.1.1</code> for supporting the clusters</li><li name="7a31" id="7a31" class="graf graf--li graf-after--li">Check <code class="markup--code markup--li-code">JupyterEnterpriseGateway 2.1.0</code> to enable the jupyter notebook service</li><li name="738a" id="738a" class="graf graf--li graf-after--li">Check <code class="markup--code markup--li-code">Livy 0.7.0</code> , which is the API we need for the Spark cluster</li><li name="18a8" id="18a8" class="graf graf--li graf-after--li">We can also change the last step completes to <code class="markup--code markup--li-code">Cluster auto-terminates</code> to save our resources, but we will just leave it there for simplicity</li><li name="aa9a" id="aa9a" class="graf graf--li graf-after--li">Click on <code class="markup--code markup--li-code">Next</code> to continue</li><li name="a66c" id="a66c" class="graf graf--li graf-after--li">On this page, we can check the clustered nodes we are going to have. Currently, we have three types of nodes: Master (the driver instance for orchestrating the jobs, and note that we can only have 1 master instance), Core (a kind of executor instance for data processing and storing), and Task (another kind of executor instance for only the data processing). Depending on the data, we can also change the machine type and the instance count. For simplicity, we just leave the default settings here.</li><li name="8076" id="8076" class="graf graf--li graf-after--li">Click on <code class="markup--code markup--li-code">Next</code> to continue</li><li name="6d1f" id="6d1f" class="graf graf--li graf-after--li">On this page, we can rename the cluster by entering a new <code class="markup--code markup--li-code">Cluster name</code>. We can also change some other general settings but we will just leave them there.</li><li name="c4ee" id="c4ee" class="graf graf--li graf-after--li">Click on <code class="markup--code markup--li-code">Next</code> to continue</li><li name="8c57" id="8c57" class="graf graf--li graf-after--li">On this page, we have to select the EC2 key pair we have set (e.g. <code class="markup--code markup--li-code">Adam</code>)</li><li name="35cc" id="35cc" class="graf graf--li graf-after--li">Click on <code class="markup--code markup--li-code">Create cluster</code> to create the instance</li><li name="5980" id="5980" class="graf graf--li graf-after--li">Then, from the <code class="markup--code markup--li-code">Clusters</code> tag, we can find the cluster named <code class="markup--code markup--li-code">My cluster</code> we have created</li></ul><p name="ce8a" id="ce8a" class="graf graf--p graf-after--li"><strong class="markup--strong markup--p-strong">(5) Connecting to the EMR Cluster Using a notebook</strong></p><ul class="postList"><li name="7c32" id="7c32" class="graf graf--li graf-after--p">Select <code class="markup--code markup--li-code">Notebooks</code> in the left navigation bar</li><li name="f0d2" id="f0d2" class="graf graf--li graf-after--li">Click on <code class="markup--code markup--li-code">Create notebook</code></li><li name="b8c4" id="b8c4" class="graf graf--li graf-after--li">Enter the <code class="markup--code markup--li-code">Notebook name</code> (e.g. <code class="markup--code markup--li-code">MyNotebook</code>)</li><li name="068b" id="068b" class="graf graf--li graf-after--li">Select <code class="markup--code markup--li-code">Choose an existing cluster</code> we have started for <code class="markup--code markup--li-code">Cluster</code> (e.g. <code class="markup--code markup--li-code">My cluster</code>)</li><li name="c135" id="c135" class="graf graf--li graf-after--li">Select <code class="markup--code markup--li-code">Use the default S3 location</code></li><li name="fbd3" id="fbd3" class="graf graf--li graf-after--li">Click on <code class="markup--code markup--li-code">Create notebook</code> to generate a notebook</li><li name="50bc" id="50bc" class="graf graf--li graf-after--li">When the notebook is no longer <code class="markup--code markup--li-code">Pending</code> (i.e. <code class="markup--code markup--li-code">Ready</code>), click on <code class="markup--code markup--li-code">Open in JupyterLab</code></li><li name="58ab" id="58ab" class="graf graf--li graf-after--li">Select <code class="markup--code markup--li-code">PySpark</code> Notebook</li></ul><figure name="2f0f" id="2f0f" class="graf graf--figure graf-after--li"><img class="graf-image" data-image-id="1*x-hawkduU_nyuEwj0058zw.png" data-width="650" data-height="179" src="https://cdn-images-1.medium.com/max/800/1*x-hawkduU_nyuEwj0058zw.png"></figure><p name="6527" id="6527" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">(6) The Definition of </strong><code class="markup--code markup--p-code"><strong class="markup--strong markup--p-strong">Sparkmagic</strong></code></p><p name="320d" id="320d" class="graf graf--p graf-after--p"><a href="https://github.com/jupyter-incubator/sparkmagic" data-href="https://github.com/jupyter-incubator/sparkmagic" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Sparkmagic</a> is a set of tools for interactively working with remote Spark clusters through Livy, a Spark REST server, in Jupyter notebooks. The Sparkmagic project includes a set of magics for interactively running Spark code in multiple languages, as well as some kernels that you can use to turn Jupyter into an integrated Spark environment.</p><figure name="26ef" id="26ef" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*reXGoxuxl96RtMzxdH6HHw.png" data-width="818" data-height="207" src="https://cdn-images-1.medium.com/max/800/1*reXGoxuxl96RtMzxdH6HHw.png"></figure><p name="68b3" id="68b3" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">(7) Basic </strong><code class="markup--code markup--p-code"><strong class="markup--strong markup--p-strong">Sparkmagic</strong></code><strong class="markup--strong markup--p-strong"> Operations</strong></p><p name="b606" id="b606" class="graf graf--p graf-after--p">Now we have opened a Jupyter Notebook with the <code class="markup--code markup--p-code">sparkmagic</code> and we are going to interact with it.</p><ul class="postList"><li name="70e8" id="70e8" class="graf graf--li graf-after--p">Open the user manual</li></ul><pre name="88b4" id="88b4" class="graf graf--pre graf-after--li">%%help</pre><ul class="postList"><li name="2bf3" id="2bf3" class="graf graf--li graf-after--pre">Outputs session information for the current Livy endpoint.</li></ul><pre name="eb3f" id="eb3f" class="graf graf--pre graf-after--li">%%info</pre><ul class="postList"><li name="b7d9" id="b7d9" class="graf graf--li graf-after--pre">Outputs the current session’s Livy logs.</li></ul><pre name="56ec" id="56ec" class="graf graf--pre graf-after--li">%%logs</pre><ul class="postList"><li name="135a" id="135a" class="graf graf--li graf-after--pre">Change the memory size to 1000M</li></ul><pre name="5408" id="5408" class="graf graf--pre graf-after--li">%%configure -f<br>{&quot;executorMemory&quot;: &quot;1000M&quot;}</pre><ul class="postList"><li name="03dc" id="03dc" class="graf graf--li graf-after--pre">Change the number of cores used for an executor</li></ul><pre name="809d" id="809d" class="graf graf--pre graf-after--li">%%configure -f<br>{&quot;executorCores&quot;: 4}</pre><ul class="postList"><li name="637d" id="637d" class="graf graf--li graf-after--pre">Locally executed the code in subsequent lines</li></ul><pre name="8097" id="8097" class="graf graf--pre graf-after--li">%%local<br>a = 1<br>print(a)</pre><ul class="postList"><li name="498b" id="498b" class="graf graf--li graf-after--pre">The result of the SQL query will be available in the <code class="markup--code markup--li-code">%%local</code> Python context as a <a href="http://pandas.pydata.org/" data-href="http://pandas.pydata.org/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Pandas</a> dataframe named <code class="markup--code markup--li-code">VAR_NAME</code></li></ul><pre name="b834" id="b834" class="graf graf--pre graf-after--li">%%sql -o VAR_NAME</pre><p name="c64e" id="c64e" class="graf graf--p graf-after--pre"><strong class="markup--strong markup--p-strong">(8) Start with </strong><code class="markup--code markup--p-code"><strong class="markup--strong markup--p-strong">Sparkmagic</strong></code></p><p name="bfc9" id="bfc9" class="graf graf--p graf-after--p">Now, let’s really configure and work with the cluster through <code class="markup--code markup--p-code">sparkmagic</code> .</p><ul class="postList"><li name="2222" id="2222" class="graf graf--li graf-after--p">Start a Spark application with the following configurations</li></ul><pre name="2ea8" id="2ea8" class="graf graf--pre graf-after--li">%%configure -f <br>{<br>&quot;conf&quot;:{<br>        &quot;spark.pyspark.python&quot;: &quot;python3&quot;,<br>        &quot;spark.pyspark.virtualenv.enabled&quot;: &quot;true&quot;,<br>        &quot;spark.pyspark.virtualenv.type&quot;:&quot;native&quot;,<br>        &quot;spark.pyspark.virtualenv.bin.path&quot;:&quot;/usr/bin/virtualenv&quot;,<br>    <br>        &quot;spark.executor.heartbeatInterval&quot;:&quot;10800s&quot;,<br>        &quot;spark.network.timeout&quot;:&quot;24h&quot;,<br>    <br>        &quot;spark.driver.memory&quot;: &quot;1G&quot;,<br>        &quot;spark.executor.memory&quot;: &quot;1G&quot;,<br>        &quot;spark.executor.cores&quot;:&quot;2&quot;,</pre><pre name="2fb0" id="2fb0" class="graf graf--pre graf-after--pre">&quot;spark.app.name&quot;:&quot;testing&quot;<br>      }<br>}</pre><ul class="postList"><li name="de82" id="de82" class="graf graf--li graf-after--pre">Creates SparkContext</li></ul><pre name="01cf" id="01cf" class="graf graf--pre graf-after--li">sc</pre><ul class="postList"><li name="604d" id="604d" class="graf graf--li graf-after--pre">Print out the section infomation</li></ul><pre name="e95a" id="e95a" class="graf graf--pre graf-after--li">%%info</pre><ul class="postList"><li name="3b5e" id="3b5e" class="graf graf--li graf-after--pre">Install extra packages (e.g. Plotly) to the</li></ul><pre name="998f" id="998f" class="graf graf--pre graf-after--li">sc.install_pypi_package(&quot;plotly&quot;)</pre><ul class="postList"><li name="45c6" id="45c6" class="graf graf--li graf-after--pre">Check all the packages installed</li></ul><pre name="eaa9" id="eaa9" class="graf graf--pre graf-after--li">sc.list_packages()</pre><ul class="postList"><li name="3c7a" id="3c7a" class="graf graf--li graf-after--pre">Create an RDD through our S3 bucket</li></ul><pre name="c85a" id="c85a" class="graf graf--pre graf-after--li">rdd = sc.textFile(&quot;s3://${Bucket Name}/${File Name}&quot;)</pre><ul class="postList"><li name="a0a5" id="a0a5" class="graf graf--li graf-after--pre">Try to print the first line of this RDD</li></ul><pre name="8729" id="8729" class="graf graf--pre graf-after--li">rdd.take(1)</pre><ul class="postList"><li name="fdd2" id="fdd2" class="graf graf--li graf-after--pre">Let’s download the <code class="markup--code markup--li-code">supervisor_sf.tsv</code> file from this <a href="https://raw.githubusercontent.com/dianewoodbridge/2019-msds694-example/master/Data/supervisor_sf.csv" data-href="https://raw.githubusercontent.com/dianewoodbridge/2019-msds694-example/master/Data/supervisor_sf.csv" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">link</a></li><li name="e5f3" id="e5f3" class="graf graf--li graf-after--li">Upload this file to our S3 bucket</li><li name="e47a" id="e47a" class="graf graf--li graf-after--li">Then, create an RDD with the content of this file</li></ul><pre name="9297" id="9297" class="graf graf--pre graf-after--li">rdd = sc.textFile(&quot;s3://${Bucket Name}/supervisor_sf.tsv&quot;)</pre><ul class="postList"><li name="f52c" id="f52c" class="graf graf--li graf-after--pre">Operate the data by RDD transformations,</li></ul><pre name="3e9c" id="3e9c" class="graf graf--pre graf-after--li">zip_id = rdd.map(lambda x : x.split(&quot;\t&quot;)).map(lambda x : (int(x[0]), int(x[1])))<br>zip_id_count = zip_id.groupByKey().map(lambda x : (x[0], len(x[1]))).sortByKey()</pre><ul class="postList"><li name="cfe5" id="cfe5" class="graf graf--li graf-after--pre">Register the DataFrame as a SQL temporary view named <code class="markup--code markup--li-code">zip_id_count_view</code></li></ul><pre name="aa4c" id="aa4c" class="graf graf--pre graf-after--li">zip_id_count_df = zip_id_count.toDF()<br>zip_id_count_df.createOrReplaceTempView(&quot;zip_id_count_view&quot;)</pre><ul class="postList"><li name="48f9" id="48f9" class="graf graf--li graf-after--pre">View the data from that SQL temporary view <code class="markup--code markup--li-code">zip_id_count_view</code> , store this as a pandas DataFrame named <code class="markup--code markup--li-code">zip_id_count_tab</code> in <code class="markup--code markup--li-code">%%local</code> Python context</li></ul><pre name="9578" id="9578" class="graf graf--pre graf-after--li">%%sql -o zip_id_count_tab<br>SELECT * FROM zip_id_count_view</pre><ul class="postList"><li name="409b" id="409b" class="graf graf--li graf-after--pre">Use <code class="markup--code markup--li-code">plotly</code> and <code class="markup--code markup--li-code">zip_id_count_tab</code> for visualization, execute the code in the <code class="markup--code markup--li-code">%%local</code> context</li></ul><pre name="9278" id="9278" class="graf graf--pre graf-after--li">%%local<br>import plotly<br>import plotly.graph_objects as go</pre><pre name="7655" id="7655" class="graf graf--pre graf-after--pre">x = zip_id_count_tab[&#39;_1&#39;]<br>y = zip_id_count_tab[&#39;_2&#39;]</pre><pre name="8d1e" id="8d1e" class="graf graf--pre graf-after--pre"># Use the hovertext kw argument for hover text<br>fig = go.Figure(data=[go.Bar(x=x, y=y, <br>                             marker_color=&#39;lightsalmon&#39;,<br>                             hovertext=x)])<br>fig.update_layout(xaxis=dict(tickformat=&quot;digit&quot;))<br>fig.show()</pre><figure name="9c2d" id="9c2d" class="graf graf--figure graf-after--pre"><img class="graf-image" data-image-id="1*USKh0MsKOPAaW7e3tOEZUw.png" data-width="1600" data-height="305" src="https://cdn-images-1.medium.com/max/800/1*USKh0MsKOPAaW7e3tOEZUw.png"></figure><ul class="postList"><li name="0f70" id="0f70" class="graf graf--li graf-after--figure">Stop the SparkContext</li></ul><pre name="694b" id="694b" class="graf graf--pre graf-after--li graf--trailing">sc.stop()</pre></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@adamedelweiss" class="p-author h-card">Adam Edelweiss</a> on <a href="https://medium.com/p/3a90cbf28e9"><time class="dt-published" datetime="2021-11-08T22:09:07.064Z">November 8, 2021</time></a>.</p><p><a href="https://medium.com/@adamedelweiss/distributed-computing-4-aws-iam-configurations-amazon-emr-and-spark-clusters-3a90cbf28e9" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on December 15, 2021.</p></footer></article></body></html>