<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>High-Performance Computer Architecture 15 | Exceptions for Tomasulo’s Algorithm and  Reorder…</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">High-Performance Computer Architecture 15 | Exceptions for Tomasulo’s Algorithm and  Reorder…</h1>
</header>
<section data-field="subtitle" class="p-summary">
Series: High-Performance Computer Architecture
</section>
<section data-field="body" class="e-content">
<section name="28e0" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="0e91" id="0e91" class="graf graf--h3 graf--leading graf--title">High-Performance Computer Architecture 15 | <strong class="markup--strong markup--h3-strong">Exceptions for Tomasulo’s Algorithm and Reorder Buffer (ROB)</strong></h3><figure name="79de" id="79de" class="graf graf--figure graf-after--h3"><img class="graf-image" data-image-id="0*25PjNzNEYDul4Nyn.png" data-width="1446" data-height="864" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/0*25PjNzNEYDul4Nyn.png"></figure><ol class="postList"><li name="4ce8" id="4ce8" class="graf graf--li graf-after--figure"><strong class="markup--strong markup--li-strong">Exceptions for Tomasulo’s Algorithm</strong></li></ol><p name="d8a1" id="d8a1" class="graf graf--p graf-after--li"><strong class="markup--strong markup--p-strong">(1) Review</strong></p><p name="518a" id="518a" class="graf graf--p graf-after--p">We have known that the<strong class="markup--strong markup--p-strong"> out-of-order execution</strong> (aka. <strong class="markup--strong markup--p-strong">OOO Execution</strong>) is implemented by <strong class="markup--strong markup--p-strong">Tomasulo’s algorithm</strong> from the last section and the overall performance can be improved a lot by such an algorithm.</p><ul class="postList"><li name="7a32" id="7a32" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong">the control dependencies</strong> by branch prediction</li><li name="023a" id="023a" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">the WAR or WAW data dependencies</strong> (false data dependencies) by register renaming</li><li name="f837" id="f837" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">the RAW data dependencies</strong> (true data dependencies) by out-of-order execution =&gt; Tomasulo’s algorithm</li><li name="2956" id="2956" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">the structural dependencies</strong> by invest in a processor that has a wider issue</li></ul><p name="7de4" id="7de4" class="graf graf--p graf-after--li">However, things can be more complicated in reality because sometimes we must maintain the order of the execution. If we don’t follow the execution in order, the program will be messed up. We will talk about this exception in this section.</p><p name="6560" id="6560" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">(2) Another Timing Example</strong></p><p name="8152" id="8152" class="graf graf--p graf-after--p">Now let’s do another example about timing. Suppose we have the following code,</p><pre name="2c0b" id="2c0b" class="graf graf--pre graf-after--p">DIV F10, F0, F6<br>L.D F2, 45(R3)<br>MUL F0, F2, F4<br>SUB F8, F2, F6</pre><p name="9dac" id="9dac" class="graf graf--p graf-after--pre">Let’s now start our calculations for timing (cycles) of issuing, dispatching, and writing results. Suppose we have an infinite instruction queue, so the issuing cycles will be,</p><pre name="7a14" id="7a14" class="graf graf--pre graf-after--p">Inst                   ISSUE        DISPATCH       WRITE_RESULTS<br>DIV F10, F0, F6          1<br>L.D F2, 45(R3)           2<br>MUL F0, F2, F4           3<br>SUB F8, F2, F6           4</pre><p name="3464" id="3464" class="graf graf--p graf-after--pre">Let’s say that a <code class="markup--code markup--p-code">DIV</code> is going to take 40 cycles for execution, then,</p><pre name="383e" id="383e" class="graf graf--pre graf-after--p">Inst                   ISSUE        DISPATCH       WRITE_RESULTS<br>DIV F10, F0, F6          1              2                42<br>L.D F2, 45(R3)           2<br>MUL F0, F2, F4           3<br>SUB F8, F2, F6           4</pre><p name="ed24" id="ed24" class="graf graf--p graf-after--pre">Suppose we have 1 Load ALU, 2 <code class="markup--code markup--p-code">MUL/DIV</code> ALUs, and 1 <code class="markup--code markup--p-code">ADD/SUB</code> ALU. In addition, it takes 10 cycles for a load execution to finish and 5 cycles for <code class="markup--code markup--p-code">MUL</code>, and 1 cycle for <code class="markup--code markup--p-code">ADD/SUB</code>. Then</p><pre name="188c" id="188c" class="graf graf--pre graf-after--p">Inst                   ISSUE        DISPATCH       WRITE_RESULTS<br>DIV F10, F0, F6          1              2                42<br>L.D F2, 45(R3)           2              2                12<br>MUL F0, F2, F4           3             13                18<br>SUB F8, F2, F6           4             13                14</pre><p name="0090" id="0090" class="graf graf--p graf-after--pre"><strong class="markup--strong markup--p-strong">(3) Exception of Out-Of-Order Execution: A Divided-by-0 Example</strong></p><p name="6aed" id="6aed" class="graf graf--p graf-after--p">Now, we have already got the timing for the given program above. And let’s say that the first instruction get a <code class="markup--code markup--p-code">0</code> value of <code class="markup--code markup--p-code">F6</code>, so the value in <code class="markup--code markup--p-code">F0</code> will be divided by <code class="markup--code markup--p-code">0</code> in cycle <strong class="markup--strong markup--p-strong">40</strong> (this is a value that we assume for this case) and this will result in an error.</p><p name="4fe1" id="4fe1" class="graf graf--p graf-after--p">If a value is divided by 0, what should happen in this processor is that the program counter (PC) of this instruction should be saved and we should jump to an <strong class="markup--strong markup--p-strong">exception handler </strong>(because we meet an error). If the exception handler comes back, we should be back to this instruction and continue executing.</p><p name="91ff" id="91ff" class="graf graf--p graf-after--p">However, what really happens is that we have already executed the instruction <code class="markup--code markup--p-code">L.D</code> , <code class="markup--code markup--p-code">MUL</code> , and <code class="markup--code markup--p-code">SUB</code> in cycle 40. If we now go to the handler and then come back, the <code class="markup--code markup--p-code">DIV</code> instruction will use the <code class="markup--code markup--p-code">F0</code> value produced by the <code class="markup--code markup--p-code">MUL</code> instruction. As a result, the <code class="markup--code markup--p-code">DIV</code> instruction can never get a correct result even if we fix the <code class="markup--code markup--p-code">F6</code> with a relatively small value.</p><p name="d8c0" id="d8c0" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">(4) Exception of Out-Of-Order Execution: A Page Fault Example</strong></p><p name="3e93" id="3e93" class="graf graf--p graf-after--p">The out-of-order exception can also happen when we have a page fault for a load instruction. If we page back from the disk and then go back to execute the load, some instructions that after the load instruction might have executed and there is no way to proceed.</p><p name="283f" id="283f" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">(5) Exception of Out-Of-Order Execution: Branch Mispredictions</strong></p><p name="edc9" id="edc9" class="graf graf--p graf-after--p">Suppose we have the following program,</p><pre name="62f4" id="62f4" class="graf graf--pre graf-after--p">DIV R1, R3, R4<br>BEQ R1, R2, Label<br>ADD R3, R4, R5<br>Label:<br>...</pre><p name="d5ad" id="d5ad" class="graf graf--p graf-after--pre">we have a <code class="markup--code markup--p-code">DIV</code> which needs 40 cycles for execution and once we get the result of <code class="markup--code markup--p-code">R1</code>, we can resolve the branch instruction <code class="markup--code markup--p-code">BEQ</code>. Meanwhile, we have fetched the instruction <code class="markup--code markup--p-code">ADD</code> although the branch should have been taken. The <code class="markup--code markup--p-code">ADD</code> instruction can finish in 1 cycle and then <code class="markup--code markup--p-code">R3</code> will be written.</p><p name="ec6c" id="ec6c" class="graf graf--p graf-after--p">However, when about 40 cycles later, we finally realize that we have mispredicted the branch. The branch should be taken and we should behave as we have never executed the <code class="markup--code markup--p-code">ADD</code> instruction. But that becomes impossible because <code class="markup--code markup--p-code">R3</code> by that time has already been updated.</p><p name="7688" id="7688" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">(6) Exception of Out-Of-Order Execution: Phantom Exceptions</strong></p><p name="fe61" id="fe61" class="graf graf--p graf-after--p">Suppose we have the following program</p><pre name="69c5" id="69c5" class="graf graf--pre graf-after--p">DIV R1, R3, R4<br>BEQ R1, R2, Label<br>ADD R3, R4, R5<br>DIV ...<br>Label:<br>...</pre><p name="c99e" id="c99e" class="graf graf--p graf-after--pre">with a <code class="markup--code markup--p-code">DIV</code> instruction after the <code class="markup--code markup--p-code">ADD</code> instruction. If we mispredicted the taken branch we are going to execute the <code class="markup--code markup--p-code">DIV</code> instruction before we know that the branch is mispredicted. If the second <code class="markup--code markup--p-code">DIV</code> generates an exception and then this exception will be triggered even though this <code class="markup--code markup--p-code">DIV</code> is never supposed to be executed. This is called a <strong class="markup--strong markup--p-strong">phantom exception</strong>.</p><p name="5b6d" id="5b6d" class="graf graf--p graf-after--p">So we have to somehow care about not having exceptions until we are sure that they should happen.</p><p name="f861" id="f861" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">(7) Correct Out-of-Order Execution</strong></p><p name="2435" id="2435" class="graf graf--p graf-after--p">In order to keep Tomasulo’s algorithm, we should execute out-of-order and we should also broadcast out-of-order. But to deal with the exceptions, we have to deposit values to registers in order. This is needed because if we write values to the registers out-of-order when some earlier instructions shouldn’t have been done, we will get some exceptions.</p><p name="d5fd" id="d5fd" class="graf graf--p graf-after--p">In order to implement this in-order feature for writing to the registers, we have to use a structure called <strong class="markup--strong markup--p-strong">reorder buffer (ROB)</strong>.</p><p name="df2a" id="df2a" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">2. Reorder Buffer</strong></p><p name="2b3f" id="2b3f" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">(1) The Definition of Reorder Buffer (ROB)</strong></p><p name="0154" id="0154" class="graf graf--p graf-after--p">A reorder buffer is used in Tomasulo’s algorithm for avoiding the exceptions of the out-of-order instruction execution. It allows the instructions to be committed in-order. The ROB remembers the program order even after issuing and it keeps the results of the instructions until they are safe to write to the registers.</p><p name="6914" id="6914" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">(2) The Implement of Reorder Buffer</strong></p><p name="dd0e" id="dd0e" class="graf graf--p graf-after--p">Now, let’s see how does the ROB looks like. The ROB is a table of entries and in each entry, we keep at least 3 fields. For example, suppose we have a ROB that can hold up to 8 instructions</p><figure name="977f" id="977f" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*IsWx3ibYwoeSsskH9bSicQ.png" data-width="1830" data-height="666" src="https://cdn-images-1.medium.com/max/800/1*IsWx3ibYwoeSsskH9bSicQ.png"></figure><p name="6ad8" id="6ad8" class="graf graf--p graf-after--figure">We need a bit for the <code class="markup--code markup--p-code">Done</code>, which is a signal that tells us whether has a valid value or not. Because in the end, we have to write the <code class="markup--code markup--p-code">value</code> to a specific register, thus we should know what register are we going to write to. This destination information of writing is stored in the <code class="markup--code markup--p-code">register</code> field.</p><p name="429e" id="429e" class="graf graf--p graf-after--p">We also need two pointers in order to keep the program instructions in the program order. The <strong class="markup--strong markup--p-strong">issue pointer</strong> tells us when we issue the next instruction, where does it go. Another pointer (called <strong class="markup--strong markup--p-strong">commit pointer</strong>) tells us when we have the in-order instructions complete, which value we can assign to the register.</p><figure name="b7b1" id="b7b1" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*y6m-nnhC2dlxx1Larq1keQ.png" data-width="1788" data-height="706" src="https://cdn-images-1.medium.com/max/800/1*y6m-nnhC2dlxx1Larq1keQ.png"></figure><p name="9cde" id="9cde" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">(3) ROB for Tomasulo’s Algorithm</strong></p><p name="968a" id="968a" class="graf graf--p graf-after--p">Now, let’s have a look at what really happens for Tomasulo’s algorithm. Suppose we have the instruction <code class="markup--code markup--p-code">ADD R1, R2, R3</code> waiting in the instruction queue at the beginning,</p><figure name="8c01" id="8c01" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*Si4Bfy8d8vQyk0-4MUoawg.png" data-width="2044" data-height="1028" src="https://cdn-images-1.medium.com/max/800/1*Si4Bfy8d8vQyk0-4MUoawg.png"></figure><p name="cfd8" id="cfd8" class="graf graf--p graf-after--figure">When we issue the <code class="markup--code markup--p-code">ADD R1, R2, R3</code> instruction, it will not only be issued to the reservation station (out-of-order) but also it will be assigned to the ROB (in-order). After it is assigned to the next instruction in the ROB, remember that we have to move the issue pointer. Note that because now we haven’t got the result of this instruction yet, we have to set the <code class="markup--code markup--p-code">Done</code> field to <code class="markup--code markup--p-code">0</code>.</p><figure name="f434" id="f434" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*LsagY1L3lrSWscsWnEJ3Vg.png" data-width="2044" data-height="1028" src="https://cdn-images-1.medium.com/max/800/1*LsagY1L3lrSWscsWnEJ3Vg.png"></figure><p name="4506" id="4506" class="graf graf--p graf-after--figure">When we rename the registers, we are not going to map <code class="markup--code markup--p-code">R1</code> to <code class="markup--code markup--p-code">RS2</code> in RAT. Instead, we will map <code class="markup--code markup--p-code">R1</code> to <code class="markup--code markup--p-code">ROB5</code> so that the final assignments to the registers are in-order.</p><figure name="245d" id="245d" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*d2QPuQ-4s1BgAigPQ5yOXw.png" data-width="2044" data-height="1028" src="https://cdn-images-1.medium.com/max/800/1*d2QPuQ-4s1BgAigPQ5yOXw.png"></figure><p name="8711" id="8711" class="graf graf--p graf-after--figure">Now the <code class="markup--code markup--p-code">RS2</code> may need to wait for some operands to continue execution. When it is dispatched to the ALU, the <code class="markup--code markup--p-code">RS2</code> will be <strong class="markup--strong markup--p-strong">freed</strong> and we will generate a result <code class="markup--code markup--p-code">val</code> from the ALU. Because now the computation has down, we can change the <code class="markup--code markup--p-code">Done</code> field to <code class="markup--code markup--p-code">1</code>,</p><figure name="fabd" id="fabd" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*hgs0xxjXVYtV680wojhRPQ.png" data-width="2044" data-height="1076" src="https://cdn-images-1.medium.com/max/800/1*hgs0xxjXVYtV680wojhRPQ.png"></figure><p name="0579" id="0579" class="graf graf--p graf-after--figure">After we commit all the instruction results before the <code class="markup--code markup--p-code">ROB5</code> , the commit pointer will point to the <code class="markup--code markup--p-code">ROB5</code> and check the <code class="markup--code markup--p-code">Done</code> field (it need to see <code class="markup--code markup--p-code">Done == 1</code> for committing a result),</p><figure name="162e" id="162e" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*w6ear8vOGVQF5xBlOv1ZNQ.png" data-width="2044" data-height="1032" src="https://cdn-images-1.medium.com/max/800/1*w6ear8vOGVQF5xBlOv1ZNQ.png"></figure><p name="c52f" id="c52f" class="graf graf--p graf-after--figure">Then finally, this result will be committed to RAT and the registers,</p><figure name="f4fc" id="f4fc" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*urM7_PQ3hfcXepom5NgWWg.png" data-width="2004" data-height="1032" src="https://cdn-images-1.medium.com/max/800/1*urM7_PQ3hfcXepom5NgWWg.png"></figure><p name="7f58" id="7f58" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">(4) Branch Misprediction Recovery by ROB</strong></p><p name="46a1" id="46a1" class="graf graf--p graf-after--p">We have said that we need ROB in order to have precise exceptions and also to be easily recover from branch mispredictions. Let’s now see how it works. Suppose we have the following program,</p><pre name="d5fa" id="d5fa" class="graf graf--pre graf-after--p">L.D R1, 0(R1)<br>BNE R1, R2, Label<br>ADD R2, R1, R1<br>MUL R3, R3, R4<br>DIV R2, R3, R3<br>Label:</pre><p name="5226" id="5226" class="graf graf--p graf-after--pre">And the branch will be taken in the end. So if we make the misprediction, the three instructions <code class="markup--code markup--p-code">ADD</code>, <code class="markup--code markup--p-code">MUL</code>, and <code class="markup--code markup--p-code">DIV</code> will be fetched. After the misprediction is done, we will have the following situation,</p><figure name="6649" id="6649" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*4zFOVW7ISXLomKkGTsh5JA.png" data-width="1980" data-height="674" src="https://cdn-images-1.medium.com/max/800/1*4zFOVW7ISXLomKkGTsh5JA.png"></figure><p name="7b2c" id="7b2c" class="graf graf--p graf-after--figure">Let’s say that we have to run <code class="markup--code markup--p-code">L.D</code> for a long time (maybe because of the cold cache), then because <code class="markup--code markup--p-code">BNE</code> and <code class="markup--code markup--p-code">ADD</code> rely on the result of <code class="markup--code markup--p-code">R1</code> , they can not be dispatched. However, because <code class="markup--code markup--p-code">MUL</code> and <code class="markup--code markup--p-code">DIV</code> don’t rely on anything, they will be dispatched and the register will be updated by the new result of <code class="markup--code markup--p-code">R2</code> and <code class="markup--code markup--p-code">R3</code> because of the misprediction.</p><figure name="228b" id="228b" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*XeBZzBAh9TR9vxcHMNxPDw.png" data-width="1766" data-height="324" src="https://cdn-images-1.medium.com/max/800/1*XeBZzBAh9TR9vxcHMNxPDw.png"></figure><p name="969d" id="969d" class="graf graf--p graf-after--figure">However, if we have the ROB, the RAT and RF will not be modified if we execute the result of these <code class="markup--code markup--p-code">MUL</code> and <code class="markup--code markup--p-code">DIV</code> instructions,</p><figure name="b472" id="b472" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*YnT7qpt9OEi5AGzyBC9jAg.png" data-width="1960" data-height="662" src="https://cdn-images-1.medium.com/max/800/1*YnT7qpt9OEi5AGzyBC9jAg.png"></figure><p name="a8bc" id="a8bc" class="graf graf--p graf-after--figure">After a while when <code class="markup--code markup--p-code">L.D</code> instruction finishes, we can finally get the value of <code class="markup--code markup--p-code">R1</code>. Let’s say the loaded value from the memory is <code class="markup--code markup--p-code">700</code>. Then the ROB will have this new value,</p><figure name="cd34" id="cd34" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*4iOe-feRWA_4zdnNet6yGw.png" data-width="1960" data-height="678" src="https://cdn-images-1.medium.com/max/800/1*4iOe-feRWA_4zdnNet6yGw.png"></figure><p name="e901" id="e901" class="graf graf--p graf-after--figure">Then we are going to commit this instruction because it is marked as done. So,</p><figure name="ca0e" id="ca0e" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*kI1fXAYyGZSxvNqTUrb7Hw.png" data-width="1960" data-height="678" src="https://cdn-images-1.medium.com/max/800/1*kI1fXAYyGZSxvNqTUrb7Hw.png"></figure><p name="87b8" id="87b8" class="graf graf--p graf-after--figure">Because the <code class="markup--code markup--p-code">BNE</code> branch instruction is much slower than <code class="markup--code markup--p-code">ADD</code> , so the <code class="markup--code markup--p-code">ROB2</code> will get the result value <code class="markup--code markup--p-code">val3</code> before we know whether can branch or not.</p><figure name="d087" id="d087" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*RSS1ocSZJkX-OhWfRDT3qA.png" data-width="1960" data-height="678" src="https://cdn-images-1.medium.com/max/800/1*RSS1ocSZJkX-OhWfRDT3qA.png"></figure><p name="a50e" id="a50e" class="graf graf--p graf-after--figure">Eventually, we get to resolve this branch <code class="markup--code markup--p-code">BNE</code> and then figure out it’s been mispredicted. So now the branch will be marked as done, but we don’t have to assign a value. But what we do is to annotate to ROB2 so when it is committed, we can know there is a misprediction problem.</p><figure name="080b" id="080b" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*SqUGUTF0aEX5TKKOFrHHMQ.png" data-width="1960" data-height="678" src="https://cdn-images-1.medium.com/max/800/1*SqUGUTF0aEX5TKKOFrHHMQ.png"></figure><p name="eb12" id="eb12" class="graf graf--p graf-after--figure">After committing the <code class="markup--code markup--p-code">ROB2</code>, we now know that we should branch to the <code class="markup--code markup--p-code">Label</code> , but how can we get rid of the mispredictions?</p><figure name="4ecf" id="4ecf" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*jzRAUOF02helEXtlvaYfiQ.png" data-width="1960" data-height="678" src="https://cdn-images-1.medium.com/max/800/1*jzRAUOF02helEXtlvaYfiQ.png"></figure><p name="2b54" id="2b54" class="graf graf--p graf-after--figure">In order to recover from the misprediction, we have to do the following two steps. The first step is to move back the issue pointer. This step will get rid of all the results after the <code class="markup--code markup--p-code">BNE</code> instruction,</p><figure name="95e4" id="95e4" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*D4XVZcRPbpAkU9HZOS6DHg.png" data-width="1960" data-height="678" src="https://cdn-images-1.medium.com/max/800/1*D4XVZcRPbpAkU9HZOS6DHg.png"></figure><p name="f389" id="f389" class="graf graf--p graf-after--figure">The second step is that we can then clear the values in the RAT because all the correct values are now already stored in the register file. So we don’t need those mappings,</p><figure name="0843" id="0843" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*nnw5UFgbNw0gHsr1KyGhqw.png" data-width="1960" data-height="678" src="https://cdn-images-1.medium.com/max/800/1*nnw5UFgbNw0gHsr1KyGhqw.png"></figure><p name="a823" id="a823" class="graf graf--p graf-after--figure">Since then, we have already recovered from the misprediction. And after this, we can fetch from the right instruction.</p><p name="9ec9" id="9ec9" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">(5) Branch Misprediction Recovery Summary</strong></p><ul class="postList"><li name="1960" id="1960" class="graf graf--li graf-after--p">Making the RAT mapping to all the corresponding registers so we can <strong class="markup--strong markup--li-strong">erase all of the renamings</strong></li><li name="c1c1" id="c1c1" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Emptying whatever in the ROB</strong> after we commit the offending branch instruction</li><li name="22a4" id="22a4" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Emptying whatever in the RS and ALU</strong></li></ul><p name="14f8" id="14f8" class="graf graf--p graf-after--li"><strong class="markup--strong markup--p-strong">(6) RAT Updates on Commit</strong></p><p name="1c0a" id="1c0a" class="graf graf--p graf-after--p">Suppose we have already had the following situation, and then we would like to commit the results in ROB. So what will happen?</p><figure name="8bb0" id="8bb0" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*IGUEGfYJWH8N1txLc9Hg9g.png" data-width="2034" data-height="716" src="https://cdn-images-1.medium.com/max/800/1*IGUEGfYJWH8N1txLc9Hg9g.png"></figure><p name="013d" id="013d" class="graf graf--p graf-after--figure">First, we will commit <code class="markup--code markup--p-code">ROB1</code>. Each time we commit an instruction, we will deposit its result in the registers no matter what the RAT really says about it. So we will add <code class="markup--code markup--p-code">R2</code> and <code class="markup--code markup--p-code">R3</code> values directly from the register file even though the renaming in the RAT says that the value in the register file is not the latest value for <code class="markup--code markup--p-code">R1</code>. However, we are then going to check whether we have the latest rename (in this case, <code class="markup--code markup--p-code">ROB4</code>) and if we haven’t got the latest value yet, we will not change the RAT. Remember we have to move the commit pointer after we commit the <code class="markup--code markup--p-code">ROB1</code> instruction. However, because the RS gets the value of <code class="markup--code markup--p-code">ROB1</code> now, it will then dispatch the <code class="markup--code markup--p-code">ROB1 * R7</code> instruction and then broadcast the result,</p><figure name="ccce" id="ccce" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*9cKLs1sVafU6IHVK1Hnt6w.png" data-width="2034" data-height="716" src="https://cdn-images-1.medium.com/max/800/1*9cKLs1sVafU6IHVK1Hnt6w.png"></figure><p name="f528" id="f528" class="graf graf--p graf-after--figure">Second, we will commit <code class="markup--code markup--p-code">ROB2</code>. Again, we will add the value of R5 and R6 directly from the RF. Because we now commit the result of <code class="markup--code markup--p-code">ROB2</code>, he <code class="markup--code markup--p-code">R9 + ROB2</code> instruction will be dispatched and its result will then be broadcasted. Meanwhile, the <code class="markup--code markup--p-code">ROB2</code> will also be eliminated from the RAT because we get the latest value of the <code class="markup--code markup--p-code">R3</code> register.</p><figure name="b714" id="b714" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*n8HC1G7btXb_8YdCAoIfNQ.png" data-width="2034" data-height="716" src="https://cdn-images-1.medium.com/max/800/1*n8HC1G7btXb_8YdCAoIfNQ.png"></figure><p name="b891" id="b891" class="graf graf--p graf-after--figure">Third, the result of <code class="markup--code markup--p-code">5 * R7</code> will be committed and then stored in <code class="markup--code markup--p-code">R1</code>. Because <code class="markup--code markup--p-code">ROB3</code> is once again, not the latest value for <code class="markup--code markup--p-code">R1</code>, the RAT will not change,</p><figure name="960c" id="960c" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*vPTats5gflhQ7d0Du5Ewdw.png" data-width="2034" data-height="716" src="https://cdn-images-1.medium.com/max/800/1*vPTats5gflhQ7d0Du5Ewdw.png"></figure><p name="0f6c" id="0f6c" class="graf graf--p graf-after--figure">Fourth, the result of <code class="markup--code markup--p-code">R4 + R8</code> will be committed directly by adding the results in RF. Because now the <code class="markup--code markup--p-code">ROB4</code> is the latest value for <code class="markup--code markup--p-code">R1</code>, we can now eliminate the corresponding value in RAT.</p><figure name="ba20" id="ba20" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*OdxE0aHqkg582uEzKIH3Dg.png" data-width="2034" data-height="716" src="https://cdn-images-1.medium.com/max/800/1*OdxE0aHqkg582uEzKIH3Dg.png"></figure><p name="8252" id="8252" class="graf graf--p graf-after--figure">Finally, let’s commit to the last one. We will finally write the result to <code class="markup--code markup--p-code">R2</code> and then (suppose in this case the register value of <code class="markup--code markup--p-code">R9</code> is <code class="markup--code markup--p-code">9</code>).</p><figure name="3a51" id="3a51" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*14M1MRrKIVYYxRYc22qEaA.png" data-width="2034" data-height="716" src="https://cdn-images-1.medium.com/max/800/1*14M1MRrKIVYYxRYc22qEaA.png"></figure><p name="3d35" id="3d35" class="graf graf--p graf-after--figure">In the end, we can find out that the RAT and the ROB are actually empty, and the register file has all the values of the registers up to date.</p><p name="f79b" id="f79b" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">3. A Long ROB Example</strong></p><p name="8d92" id="8d92" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">(0) Basic Setups</strong></p><p name="18f0" id="18f0" class="graf graf--p graf-after--p">Suppose we have the following program,</p><pre name="ebcf" id="ebcf" class="graf graf--pre graf-after--p">DIV R2,R3,R4<br>MUL R1,R5,R8<br>ADD R3,R7,R8<br>MUL R1,R1,R3<br>SUB R4,R1,R5<br>ADD R1,R4,R2</pre><p name="5066" id="5066" class="graf graf--p graf-after--pre">And the initial state of the hardware is,</p><figure name="cda9" id="cda9" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*hINBTrQpX-NmjzsKKqArgw.png" data-width="2070" data-height="864" src="https://cdn-images-1.medium.com/max/800/1*hINBTrQpX-NmjzsKKqArgw.png"></figure><p name="df3f" id="df3f" class="graf graf--p graf-after--figure">The cycles we need for each type of executions are,</p><pre name="f6d9" id="f6d9" class="graf graf--pre graf-after--p">ADD:  1 cycle<br>MUL: 10 cycles<br>DIV: 40 cycles </pre><p name="e92e" id="e92e" class="graf graf--p graf-after--pre">Also, we assume that we can have infinite ALUs for <code class="markup--code markup--p-code">MUL/DIV/ADD/SUB</code>.</p><p name="0135" id="0135" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">(1) Cycle 1</strong></p><figure name="5d6c" id="5d6c" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*NiYvD1Ma_fELqH_T5iz6kA.png" data-width="2070" data-height="864" src="https://cdn-images-1.medium.com/max/800/1*NiYvD1Ma_fELqH_T5iz6kA.png"></figure><p name="5cea" id="5cea" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">(2) Cycle 2</strong></p><figure name="0748" id="0748" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*Sa5cujm3uyksvfJH_MHZ-A.png" data-width="2070" data-height="864" src="https://cdn-images-1.medium.com/max/800/1*Sa5cujm3uyksvfJH_MHZ-A.png"></figure><p name="5b98" id="5b98" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">(3) Cycle 3</strong></p><figure name="a33a" id="a33a" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*w1_i0l9d3mBSB1QMgE8uWg.png" data-width="2070" data-height="864" src="https://cdn-images-1.medium.com/max/800/1*w1_i0l9d3mBSB1QMgE8uWg.png"></figure><p name="272b" id="272b" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">(4) Cycle 4</strong></p><figure name="05ef" id="05ef" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*fXKginO5HYfeyOAerxFjtw.png" data-width="2070" data-height="864" src="https://cdn-images-1.medium.com/max/800/1*fXKginO5HYfeyOAerxFjtw.png"></figure><p name="b517" id="b517" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">(5) Cycle 5</strong></p><figure name="2c37" id="2c37" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*YMGtKfjfTsRJWMlT70kbqQ.png" data-width="2070" data-height="864" src="https://cdn-images-1.medium.com/max/800/1*YMGtKfjfTsRJWMlT70kbqQ.png"></figure><p name="cda3" id="cda3" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">(6) Cycle 6</strong></p><figure name="1369" id="1369" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*cRS8uCvLGpLP1i67Bg0yog.png" data-width="2070" data-height="864" src="https://cdn-images-1.medium.com/max/800/1*cRS8uCvLGpLP1i67Bg0yog.png"></figure><p name="6707" id="6707" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">(7) Cycle 13</strong></p><figure name="ae5b" id="ae5b" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*_ChRqMqAKxymjTF2fTb0CQ.png" data-width="2070" data-height="864" src="https://cdn-images-1.medium.com/max/800/1*_ChRqMqAKxymjTF2fTb0CQ.png"></figure><p name="b922" id="b922" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">(8) Cycle 14</strong></p><figure name="6870" id="6870" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*oB-GRjb9jVVPInPFMmemMA.png" data-width="2070" data-height="864" src="https://cdn-images-1.medium.com/max/800/1*oB-GRjb9jVVPInPFMmemMA.png"></figure><p name="9e54" id="9e54" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">(9) Cycle 24</strong></p><figure name="d3b7" id="d3b7" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*JFjZoLQm0-qXSUuptDvehA.png" data-width="2070" data-height="864" src="https://cdn-images-1.medium.com/max/800/1*JFjZoLQm0-qXSUuptDvehA.png"></figure><p name="c1e3" id="c1e3" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">(10) Cycle 25</strong></p><figure name="8533" id="8533" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*Y1Wjw0tFIdDARG-m8CIalQ.png" data-width="2070" data-height="864" src="https://cdn-images-1.medium.com/max/800/1*Y1Wjw0tFIdDARG-m8CIalQ.png"></figure><p name="db59" id="db59" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">(11) Cycle 26</strong></p><figure name="ed92" id="ed92" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*PP18L2AZZKzwQ-iW_md-7g.png" data-width="2070" data-height="864" src="https://cdn-images-1.medium.com/max/800/1*PP18L2AZZKzwQ-iW_md-7g.png"></figure><p name="82d9" id="82d9" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">(12) Cycle 42</strong></p><figure name="44bf" id="44bf" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*hMl9m4RBwN34bD7NrzcShQ.png" data-width="2070" data-height="864" src="https://cdn-images-1.medium.com/max/800/1*hMl9m4RBwN34bD7NrzcShQ.png"></figure><p name="d719" id="d719" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">(13) Cycle 43</strong></p><figure name="08a3" id="08a3" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*csI7xGsTBbapi9MKuLfq8w.png" data-width="2070" data-height="864" src="https://cdn-images-1.medium.com/max/800/1*csI7xGsTBbapi9MKuLfq8w.png"></figure><p name="8db6" id="8db6" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">(14) Cycle 44</strong></p><figure name="a606" id="a606" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*WTdgWSelCxcWk9EwMQMayw.png" data-width="2070" data-height="864" src="https://cdn-images-1.medium.com/max/800/1*WTdgWSelCxcWk9EwMQMayw.png"></figure><p name="5aa6" id="5aa6" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">(15) Cycle 45</strong></p><figure name="9966" id="9966" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*O1cP_Q-kRNKzXyUy31up5g.png" data-width="2070" data-height="864" src="https://cdn-images-1.medium.com/max/800/1*O1cP_Q-kRNKzXyUy31up5g.png"></figure><p name="ec15" id="ec15" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">(16) Cycle 46</strong></p><figure name="8999" id="8999" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*GuWcWRyeV2FpkvwsfR3JvQ.png" data-width="2070" data-height="864" src="https://cdn-images-1.medium.com/max/800/1*GuWcWRyeV2FpkvwsfR3JvQ.png"></figure><p name="c7bc" id="c7bc" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">(17) Cycle 47</strong></p><figure name="f5f3" id="f5f3" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*XDzd8yifBWoUFZ2oLZSn4Q.png" data-width="2070" data-height="864" src="https://cdn-images-1.medium.com/max/800/1*XDzd8yifBWoUFZ2oLZSn4Q.png"></figure><p name="a81b" id="a81b" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">(18) Cycle 48</strong></p><figure name="d78c" id="d78c" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*0ToNm5xWVTnchNUeYOg8iQ.png" data-width="2070" data-height="864" src="https://cdn-images-1.medium.com/max/800/1*0ToNm5xWVTnchNUeYOg8iQ.png"></figure><p name="c086" id="c086" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">4. A Useful Tool</strong></p><p name="2436" id="2436" class="graf graf--p graf-after--p graf--trailing">If you want to simulate the ROB in a more simple way, check out this <a href="http://www.ecs.umass.edu/ece/koren/architecture/ROB/rob_simulator.htm" data-href="http://www.ecs.umass.edu/ece/koren/architecture/ROB/rob_simulator.htm" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><em class="markup--em markup--p-em">simulator</em></a> for ROB and Tomasulo’s algorithm.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@adamedelweiss" class="p-author h-card">Adam Edelweiss</a> on <a href="https://medium.com/p/2fc883d89d32"><time class="dt-published" datetime="2021-02-02T10:34:43.841Z">February 2, 2021</time></a>.</p><p><a href="https://medium.com/@adamedelweiss/high-performance-computer-architecture-15-exceptions-for-tomasulos-algorithm-and-reorder-2fc883d89d32" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on December 15, 2021.</p></footer></article></body></html>